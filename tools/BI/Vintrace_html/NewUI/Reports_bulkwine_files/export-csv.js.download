/**
 * A small plugin for getting the CSV of a categorized chart
 */
(function (Highcharts) {
    
    
    var each = Highcharts.each;
    Highcharts.Chart.prototype.getCSV = function () {
        var columns = [],
            line,
            tempLine,
            csv = "", 
            row,
            col,
            options = (this.options.exporting || {}).csv || {},

            // Options
            dateFormat = options.dateFormat || '%Y-%m-%d %H:%M:%S',
            itemDelimiter = options.itemDelimiter || ',', // use ';' for direct import to Excel
            lineDelimiter = options.lineDelimeter || '\n';

        each (this.series, function (series) {
        	
        	var seriesName = series.name;
        	
            if (series.options.includeInCSVExport !== false) {
                if (series.xAxis) {
                    var xData = [];
                    
                    series.xData.forEach(function (xv) {
                    	xData.push(xv);
                    });
                    
                    var xTitle = 'X values';
                    if (series.xAxis.isDatetimeAxis) {
                        xData = Highcharts.map(xData, function (x) {
                            return Highcharts.dateFormat(dateFormat, x)
                        });
                        xTitle = 'DateTime';
                    } else if (series.xAxis.categories) {
                        xData = Highcharts.map(xData, function (x) {
                            return Highcharts.pick(series.xAxis.categories[x], x);
                        });
                        xTitle = 'Category';
                    }
                    
                    columns.push(xData);
                    columns[columns.length - 1].unshift(xTitle);
                    
                } else if (series.userOptions && series.userOptions.type == "pie") {
                	var catTitle = "Category";
                	seriesName = "Value";
                	
                	var catValues = [];
                	series.data.forEach(function (c) {
                		catValues.push(c.name);
                	});
                	
                	columns.push(catValues);
                    columns[columns.length - 1].unshift(catTitle);
                }
                
                var yData = [];
                
                series.yData.forEach(function (yv) {
                	yData.push(yv);
                });
                
                columns.push(yData);
                columns[columns.length - 1].unshift(seriesName);
                
                if (series.userOptions && series.userOptions.type == "pie") {
                	var pcntTitle = "Percent (%)";
                	
                	var tot = 0;
                	
                	
                	series.yData.forEach(function (yv) {
                		tot += yv;
                	});
                	
                	if (tot > 0) {
                		
                		var pcntVals = [];
                		
                		series.yData.forEach(function (yv) {
                    		pcntVals.push((yv / tot) * 100);
                    	});
                		
	                	columns.push(pcntVals);
	                    columns[columns.length - 1].unshift(pcntTitle);
                	}
                }
            }
        });

        var maxRows = 0;
        for (col = 0; col < columns.length; col++) {
        	if (columns[col].length > maxRows) {
        		maxRows = columns[col].length;
        	}
        }
        
        for (col = 0; col < columns.length; col++) {
        	if (columns[col].length < maxRows) {
        		for (var i = 0; i < maxRows - columns[col].length; i++) {
        			columns[col].push("");
        		}
        	}
        }
        
        // Transform the columns to CSV
        for (row = 0; row < maxRows; row++) {
            line = [];
            for (col = 0; col < columns.length; col++) {
                line.push(columns[col][row]);
            }
            csv += line.join(itemDelimiter) + lineDelimiter;
        }

        return csv;
    };

    // Now we want to add "Download CSV" to the exporting menu. We post the CSV
    // to a simple PHP script that returns it with a content-type header as a 
    // downloadable file.
    // The source code for the PHP script can be viewed at 
    // https://raw.github.com/highslide-software/highcharts.com/master/studies/csv-export/csv.php
    if (Highcharts.getOptions().exporting) {
        Highcharts.getOptions().exporting.buttons.contextButton.menuItems.push({
            text: Highcharts.getOptions().lang.downloadCSV || "Download CSV",
            onclick: function () {            	
                Highcharts.post('api/v6/export/data', {
                    fileData: this.getCSV(),
                    fileName: this.title.textStr+".csv",
                    fileType: "text/csv"
                });
            }
        });
    }
}(Highcharts));

