var isCurrentPswdValid, isNewPswdValid, isConfirmPswdValid = false;

function validateNewPwd() {
	removeInvalidStyle("changePasswordForm:newPwdStatus");
	var pswd = $(document.getElementById("changePasswordForm:newPwd")).val();
	var hasAnyInvalidRule = false;

	$("p.pwd-rule").each(function() {
		if($(this).attr('data-pattern')) {
			if(!validatePwdRule(pswd, $(this))) {
				hasAnyInvalidRule = true;
			}
		}
		else {
			var minVariance = $(this).attr('data-variance');
			var variance = 0;
			$(this).siblings().find('p.pwd-subrule').each(function() {
				if($(this).attr('data-pattern')) {
					if(validatePwdRule(pswd, $(this))) {
						variance ++;
					}
				}
			});

			if(variance < minVariance) {
				hasAnyInvalidRule = true;
				setInvalid($(this));
			}
			else {
				setValid($(this));
			}
		}
	});
	isNewPswdValid = !hasAnyInvalidRule && Boolean(pswd);
	if(isNewPswdValid) {
		setPwdValidStyle("changePasswordForm:newPwdStatus");
	}
	else {
		resetStatusStyle("changePasswordForm:newPwdStatus");
	}
}

function validatePwdRule(pswd, rule) {
	if(pswd.match(new RegExp(rule.attr('data-pattern')))) {
		setValid(rule);
		return true;
	}
	else {
		setInvalid(rule);
		return false;
	}
}

function setValid(rule){
	rule.removeClass('vin-pwd-invalid-rule').addClass('vin-pwd-valid-rule');
}

function setInvalid(rule){
	rule.removeClass('vin-pwd-valid-rule').addClass('vin-pwd-invalid-rule');
}

function confirmNewPassword(shouldRemoveInvalidity)  {
	if(shouldRemoveInvalidity) {
		removeInvalidStyle("changePasswordForm:confirmPwdStatus");
	}
	var newPswd = $(document.getElementById("changePasswordForm:newPwd")).val();
	var confirmPswd = $(document.getElementById("changePasswordForm:confirmPwd")).val();

	if(!confirmPswd || !newPswd) return;

	isConfirmPswdValid =  (newPswd == confirmPswd ) && isNewPswdValid;

	if(isConfirmPswdValid) {
		setPwdValidStyle("changePasswordForm:confirmPwdStatus");
	}
	else if(shouldRemoveInvalidity) {
		resetStatusStyle("changePasswordForm:confirmPwdStatus");
	}
	else {
		setPwdInvalidStyle("changePasswordForm:confirmPwd", "changePasswordForm:confirmPwdStatus");
	}
}

function setPwdValidStyle(element) {
	removeInvalidStyle(element);
	$(document.getElementById(element)).find('i').addClass('vin-pwd-green-check');
	checkValidityOfAllFields();
}

function setPwdInvalidStyle(element, status) {
	if($(document.getElementById(element)).val()) {
		$(document.getElementById(status)).find('i').removeClass('vin-pwd-green-check').addClass('vin-pwd-red-error');
	}
	checkValidityOfAllFields();
}	

function removeInvalidStyle(element) {
	$(document.getElementById(element)).find('i').removeClass('vin-pwd-red-error');
}

function checkNewPwdValidityOnBlur() {
	if(!isNewPswdValid) {
		setPwdInvalidStyle("changePasswordForm:newPwd", "changePasswordForm:newPwdStatus");
	}
}

function checkConfirmPwdValidityOnBlur() {
	if(!isConfirmPswdValid) {
		setPwdInvalidStyle("changePasswordForm:confirmPwd", "changePasswordForm:confirmPwdStatus");
	}
}

function setCurrentPswdStatusStyle(status) {
	isCurrentPswdValid = status;
	if(isCurrentPswdValid) {
		setPwdValidStyle("changePasswordForm:currentPwdStatus");
	}
	else {
		setPwdInvalidStyle("changePasswordForm:currentPwd", "changePasswordForm:currentPwdStatus");
	}
}

function checkValidityOfAllFields() {
	if(isCurrentPswdValid == true && isNewPswdValid == true && isConfirmPswdValid == true) {
		 $(document.getElementById("changePasswordForm:changePwdButton")).removeAttr("disabled").removeClass('ui-state-disabled');
	} else {
		 $(document.getElementById("changePasswordForm:changePwdButton")).attr("disabled", true).addClass('ui-state-disabled');
	 }
}

function onLoadPwdScreen() {
	$(document.getElementById("changePasswordForm:changePwdButton")).attr("disabled", true).addClass('ui-state-disabled');
}

function resetPwdFormFields() {
	$(document.getElementById("changePasswordForm:newPwd")).val('');
	$(document.getElementById("changePasswordForm:confirmPwd")).val('');
	$(document.getElementById("changePasswordForm:currentPwd")).val('');
	resetStatusStyle("changePasswordForm:confirmPwdStatus");
	resetStatusStyle("changePasswordForm:currentPwdStatus");
	resetStatusStyle("changePasswordForm:newPwdStatus");
	
	$("p.pwd-rule").each(function() {
		setInvalid($(this));
	});
	
	$("p.pwd-subrule").each(function() {
		setInvalid($(this));
	});
}

function resetStatusStyle(element) {
	$(document.getElementById(element)).find('i').removeClass('vin-pwd-green-check').removeClass('vin-pwd-red-error');
	checkValidityOfAllFields();
}
